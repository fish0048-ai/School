rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuth() {
      return request.auth != null;
    }
    function userRole() {
      let u = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return u != null && u.data != null ? u.data.role : 'student';
    }
    function isTeacher() {
      return isAuth() && userRole() == 'teacher';
    }
    function isTeacherOrStaff() {
      return isAuth() && (userRole() == 'teacher' || userRole() == 'staff');
    }

    match /announcements/{docId} {
      allow read: if true;
      allow write: if isTeacherOrStaff();
    }
    match /homework/{docId} {
      allow read: if true;
      allow write: if isTeacherOrStaff();
    }
    match /schedules/{docId} {
      allow read: if true;
      allow write: if isTeacher();
    }
    match /schedules_teacher/{docId} {
      allow read: if true;
      allow write: if isTeacher();
    }
    match /countdown_events/{docId} {
      allow read: if true;
      allow write: if isTeacher();
    }
    match /honor_roll/{docId} {
      allow read: if true;
      allow write: if isTeacher();
    }
    match /violations/{docId} {
      allow read, write: if isTeacherOrStaff();
    }
    match /seating/{docId} {
      allow read, write: if isTeacherOrStaff();
    }
    match /gallery_photos/{docId} {
      allow read: if true;
      allow create: if isAuth();
      allow update, delete: if isTeacherOrStaff();
    }
    match /class_fund/{docId} {
      allow read, write: if isTeacherOrStaff();
    }
    match /stories/{docId} {
      allow read: if true;
      allow write: if isTeacherOrStaff();
    }
    match /links/{docId} {
      allow read: if true;
      allow write: if isTeacherOrStaff();
    }
    match /users/{userId} {
      allow read: if isAuth() && (request.auth.uid == userId || isTeacher());
      allow write: if isTeacher();
    }
  }
}
