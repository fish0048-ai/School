(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[235],{4269:(e,l,t)=>{"use strict";function s(e){let l={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(e||"").replace(/[&<>"']/g,e=>{var t;return null!=(t=l[e])?t:e})}t.d(l,{ZD:()=>s})},4585:(e,l,t)=>{"use strict";t.d(l,{db:()=>n,j:()=>d});var s=t(2078),a=t(2553),r=t(9390);let i=(0,s.Wp)({apiKey:"AIzaSyDD_LVP9WTmEJP1ug68ajrFqQufu65X_BA",authDomain:"cish-906-school.firebaseapp.com",projectId:"cish-906-school",storageBucket:"cish-906-school.firebasestorage.app",messagingSenderId:"795413031258",appId:"1:795413031258:web:13c9916b84c07cd4dbeb63"}),d=(0,a.xI)(i),n=(0,r.aU)(i)},4901:(e,l,t)=>{"use strict";t.d(l,{A:()=>o,AuthProvider:()=>c});var s=t(5155),a=t(2115),r=t(2553),i=t(9390),d=t(4585);let n=(0,a.createContext)(null);function c(e){let{children:l}=e,[t,c]=(0,a.useState)(null),[o,u]=(0,a.useState)(null),[m,x]=(0,a.useState)(!0);(0,a.useEffect)(()=>{let e=(0,r.hg)(d.j,async e=>{if(c(e),e){var l,t,s;let a=(await (0,i.x7)((0,i.H9)(d.db,"users",e.uid))).data();u({uid:e.uid,email:null!=(l=e.email)?l:null,role:null!=(t=null==a?void 0:a.role)?t:"student",displayName:null!=(s=e.displayName)?s:null==a?void 0:a.displayName})}else u(null);x(!1)});return()=>e()},[]);let b=async(e,l)=>{await (0,r.x9)(d.j,e,l)},p=async()=>{let e=new r.HF;await (0,r.df)(d.j,e)},f=async()=>{await (0,r.CI)(d.j),u(null)};return(0,s.jsx)(n.Provider,{value:{user:t,profile:o,loading:m,signIn:b,signInWithGoogle:p,signOut:f,hasRole:function(){for(var e=arguments.length,l=Array(e),t=0;t<e;t++)l[t]=arguments[t];return!!o&&l.includes(o.role)}},children:l})}function o(){let e=(0,a.useContext)(n);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},7064:(e,l,t)=>{Promise.resolve().then(t.bind(t,9790))},9790:(e,l,t)=>{"use strict";t.r(l),t.d(l,{default:()=>o});var s=t(5155),a=t(2115),r=t(9390),i=t(4585),d=t(4269),n=t(4901);let c="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";function o(){let{user:e,profile:l}=(0,n.A)(),[t,o]=(0,a.useState)([]),[u,m]=(0,a.useState)(!0),[x,b]=(0,a.useState)(!1),[p,f]=(0,a.useState)(!1),[h,g]=(0,a.useState)({album:"",title:"",desc:"",file:null}),j=()=>{(0,r.GG)((0,r.P)((0,r.rJ)(i.db,"gallery_photos"),(0,r.My)("date","desc"))).then(e=>{o(e.docs.map(e=>({id:e.id,...e.data()})))}).catch(console.error).finally(()=>m(!1))};(0,a.useEffect)(()=>{j()},[]);let v=async t=>{if(t.preventDefault(),c&&h.file&&e){f(!0);try{let t=new FileReader,s=await new Promise((e,l)=>{t.onload=()=>{let l=t.result.match(/^data:([^;]+);base64,(.+)$/);e(l?l[2]:"")},t.onerror=l,t.readAsDataURL(h.file)}),a=new Date().toISOString().slice(0,10),d=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:a,album:h.album||"未分類",title:h.title||h.file.name,uploader:(null==l?void 0:l.displayName)||e.email||"",desc:h.desc||"",filename:h.file.name,image:s})}),n=await d.json().catch(()=>({})),o=(null==n?void 0:n.url)||(null==n?void 0:n.fileUrl);if(!o)throw Error("Apps Script 未回傳 url，請確認部署正確");await (0,r.gS)((0,r.rJ)(i.db,"gallery_photos"),{url:o,title:h.title||h.file.name,album:h.album||"未分類",desc:h.desc||"",date:a,uploader:(null==l?void 0:l.displayName)||e.email||""}),b(!1),g({album:"",title:"",desc:"",file:null}),j()}catch(e){console.error(e),alert(e instanceof Error?e.message:"上傳失敗，請確認 NEXT_PUBLIC_UPLOAD_API 正確且 Apps Script 已部署並回傳 { url }")}finally{f(!1)}}},N=t.reduce((e,l)=>{let t=l.album||"未分類";return e[t]||(e[t]=[]),e[t].push(l),e},{});return u?(0,s.jsx)("div",{className:"flex items-center justify-center py-20",children:(0,s.jsx)("i",{className:"fas fa-circle-notch fa-spin text-4xl text-blue-500"})}):(0,s.jsxs)("div",{className:"bg-white p-4 sm:p-6 rounded-2xl shadow-sm border-t-4 border-blue-500",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,s.jsxs)("h2",{className:"text-xl font-bold text-slate-800",children:[(0,s.jsx)("i",{className:"fas fa-images text-blue-500 mr-2"})," 班級相簿"]}),c&&e&&(0,s.jsxs)("button",{onClick:()=>b(!0),className:"fixed bottom-20 right-6 bg-blue-500 text-white px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 z-10",children:[(0,s.jsx)("i",{className:"fas fa-cloud-upload-alt"}),"上傳照片"]})]}),x&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:(0,s.jsxs)("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-6",children:[(0,s.jsxs)("h3",{className:"text-lg font-bold text-slate-800 mb-4",children:[(0,s.jsx)("i",{className:"fas fa-cloud-upload-alt text-blue-500 mr-2"})," 上傳照片"]}),(0,s.jsxs)("form",{onSubmit:v,className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"相簿名稱"}),(0,s.jsx)("input",{type:"text",value:h.album,onChange:e=>g(l=>({...l,album:e.target.value})),className:"w-full p-2 border border-slate-300 rounded-lg",placeholder:"未分類"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"標題"}),(0,s.jsx)("input",{type:"text",value:h.title,onChange:e=>g(l=>({...l,title:e.target.value})),className:"w-full p-2 border border-slate-300 rounded-lg",placeholder:"照片標題"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"說明"}),(0,s.jsx)("input",{type:"text",value:h.desc,onChange:e=>g(l=>({...l,desc:e.target.value})),className:"w-full p-2 border border-slate-300 rounded-lg",placeholder:"選填"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"選擇圖片"}),(0,s.jsx)("input",{type:"file",accept:"image/*",required:!0,onChange:e=>g(l=>{var t;return{...l,file:(null==(t=e.target.files)?void 0:t[0])||null}}),className:"w-full p-2 border border-slate-300 rounded-lg"})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)("button",{type:"submit",disabled:p,className:"flex-1 bg-blue-600 text-white font-bold py-2 rounded-lg disabled:opacity-50",children:[p?(0,s.jsx)("i",{className:"fas fa-spinner fa-spin mr-2"}):null,"上傳"]}),(0,s.jsx)("button",{type:"button",onClick:()=>b(!1),className:"px-4 py-2 border border-slate-300 rounded-lg text-slate-700",children:"取消"})]})]})]})}),0===Object.keys(N).length?(0,s.jsx)("p",{className:"text-center text-slate-500 py-10",children:"尚無照片"}):(0,s.jsx)("div",{className:"space-y-6",children:Object.entries(N).map(e=>{let[l,t]=e;return(0,s.jsxs)("div",{className:"border border-slate-200 rounded-xl overflow-hidden",children:[(0,s.jsxs)("div",{className:"p-4 bg-slate-50 font-bold text-slate-700 flex items-center",children:[(0,s.jsx)("i",{className:"fas fa-folder-open text-yellow-500 mr-2"}),(0,d.ZD)(l),(0,s.jsx)("span",{className:"ml-2 text-xs bg-white border border-slate-200 px-2 py-0.5 rounded-full text-slate-500",children:t.length})]}),(0,s.jsx)("div",{className:"p-4 grid grid-cols-2 md:grid-cols-3 gap-4",children:t.map(e=>(0,s.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"aspect-[4/3] bg-slate-100 rounded-lg overflow-hidden block group",children:[(0,s.jsx)("img",{src:e.url,alt:e.title,className:"w-full h-full object-cover group-hover:scale-105 transition"}),(0,s.jsx)("div",{className:"p-2 bg-black/50 text-white text-xs truncate",children:(0,d.ZD)(e.title||e.desc||"")})]},e.id))})]},l)})})]})}}},e=>{e.O(0,[399,563,320,441,255,358],()=>e(e.s=7064)),_N_E=e.O()}]);