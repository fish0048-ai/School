(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[87],{2740:(e,t,l)=>{Promise.resolve().then(l.bind(l,9540))},4585:(e,t,l)=>{"use strict";l.d(t,{db:()=>o,j:()=>s});var a=l(2078),n=l(2553),r=l(9390);let i=(0,a.Wp)({apiKey:"AIzaSyDD_LVP9WTmEJP1ug68ajrFqQufu65X_BA",authDomain:"cish-906-school.firebaseapp.com",projectId:"cish-906-school",storageBucket:"cish-906-school.firebasestorage.app",messagingSenderId:"795413031258",appId:"1:795413031258:web:13c9916b84c07cd4dbeb63"}),s=(0,n.xI)(i),o=(0,r.aU)(i)},4901:(e,t,l)=>{"use strict";l.d(t,{A:()=>c,AuthProvider:()=>u});var a=l(5155),n=l(2115),r=l(2553),i=l(9390),s=l(4585);let o=(0,n.createContext)(null);function u(e){let{children:t}=e,[l,u]=(0,n.useState)(null),[c,d]=(0,n.useState)(null),[h,f]=(0,n.useState)(!0);(0,n.useEffect)(()=>{let e=(0,r.hg)(s.j,async e=>{if(u(e),e){var t,l,a;let n=(await (0,i.x7)((0,i.H9)(s.db,"users",e.uid))).data();d({uid:e.uid,email:null!=(t=e.email)?t:null,role:null!=(l=null==n?void 0:n.role)?l:"student",displayName:null!=(a=e.displayName)?a:null==n?void 0:n.displayName})}else d(null);f(!1)});return()=>e()},[]);let p=async(e,t)=>{await (0,r.x9)(s.j,e,t)},m=async()=>{let e=new r.HF;await (0,r.df)(s.j,e)},g=async()=>{await (0,r.CI)(s.j),d(null)};return(0,a.jsx)(o.Provider,{value:{user:l,profile:c,loading:h,signIn:p,signInWithGoogle:m,signOut:g,hasRole:function(){for(var e=arguments.length,t=Array(e),l=0;l<e;l++)t[l]=arguments[l];return!!c&&t.includes(c.role)}},children:t})}function c(){let e=(0,n.useContext)(o);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},9540:(e,t,l)=>{"use strict";l.r(t),l.d(t,{default:()=>c});var a=l(5155),n=l(2115),r=l(9390),i=l(4585),s=l(4901);let o="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec",u=["#000","#f00","#0a0","#00f","#f80","#80f","#fff"];function c(){let e=(0,n.useRef)(null),[t,l]=(0,n.useState)(!1),[c,d]=(0,n.useState)("#000"),[h,f]=(0,n.useState)(4),[p,m]=(0,n.useState)(!1),{user:g,profile:b}=(0,s.A)();(0,n.useEffect)(()=>{let t=e.current;if(!t)return;let l=t.getContext("2d");if(!l)return;let a=window.devicePixelRatio||1,n=t.getBoundingClientRect();t.width=n.width*a,t.height=n.height*a,l.scale(a,a),l.fillStyle="#fff",l.fillRect(0,0,n.width,n.height)},[]);let x=t=>{var l,a;let n=e.current;if(!n)return{x:0,y:0};let r=n.getBoundingClientRect(),i="touches"in t?null==(l=t.touches[0])?void 0:l.clientX:t.clientX,s="touches"in t?null==(a=t.touches[0])?void 0:a.clientY:t.clientY;return{x:i-r.left,y:s-r.top}},v=l=>{if(!t)return;let a=e.current,n=null==a?void 0:a.getContext("2d");if(!n)return;let{x:r,y:i}=x(l);n.strokeStyle=c,n.lineWidth=h,n.lineCap="round",n.lineTo(r,i),n.stroke(),n.beginPath(),n.moveTo(r,i)},w=t=>{var a;l(!0);let{x:n,y:r}=x(t),i=null==(a=e.current)?void 0:a.getContext("2d");i&&(i.beginPath(),i.moveTo(n,r))},y=()=>l(!1),N=async()=>{if(!o||!g)return void alert("請設定 NEXT_PUBLIC_UPLOAD_API 並登入後上傳");let t=e.current;if(t){m(!0);try{let e=t.toDataURL("image/png").replace(/^data:image\/\w+;base64,/,""),l=new Date().toISOString().slice(0,10),a=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:l,album:"塗鴉牆",title:"塗鴉 ".concat(l),uploader:(null==b?void 0:b.displayName)||g.email||"",desc:"",filename:"graffiti-".concat(Date.now(),".png"),image:e})}),n=await a.json().catch(()=>({})),s=(null==n?void 0:n.url)||(null==n?void 0:n.fileUrl);if(!s)throw Error("未取得上傳 URL");await (0,r.gS)((0,r.rJ)(i.db,"gallery_photos"),{url:s,title:"塗鴉 ".concat(l),album:"塗鴉牆",desc:"",date:l,uploader:(null==b?void 0:b.displayName)||g.email||""}),alert("已上傳至相簿！")}catch(e){console.error(e),alert("上傳失敗，請確認 Apps Script 已部署")}finally{m(!1)}}};return(0,a.jsxs)("div",{className:"bg-white p-4 sm:p-6 rounded-2xl shadow-sm border-t-4 border-purple-500",children:[(0,a.jsxs)("h2",{className:"text-xl font-bold text-slate-800 mb-4",children:[(0,a.jsx)("i",{className:"fas fa-paint-brush text-purple-500 mr-2"})," 塗鴉牆"]}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-2 mb-4",children:[u.map(e=>(0,a.jsx)("button",{onClick:()=>d(e),className:"w-8 h-8 rounded-full border-2 ".concat(c===e?"border-slate-800":"border-slate-300"),style:{backgroundColor:e}},e)),(0,a.jsx)("input",{type:"range",min:"1",max:"20",value:h,onChange:e=>f(Number(e.target.value)),className:"w-24 align-middle"}),(0,a.jsxs)("span",{className:"text-sm text-slate-500",children:["粗細 ",h]}),(0,a.jsx)("button",{onClick:()=>{let t=e.current,l=null==t?void 0:t.getContext("2d");l&&t&&(t.getBoundingClientRect(),l.fillStyle="#fff",l.fillRect(0,0,t.width,t.height))},className:"ml-2 px-3 py-1 bg-slate-200 rounded-lg text-sm font-medium hover:bg-slate-300",children:"清除"}),(0,a.jsx)("button",{onClick:()=>{let t=e.current;if(!t)return;let l=document.createElement("a");l.download="塗鴉-".concat(new Date().toISOString().slice(0,10),".png"),l.href=t.toDataURL("image/png"),l.click()},className:"px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium hover:bg-purple-200",children:"下載"}),o&&g&&(0,a.jsxs)("button",{onClick:N,disabled:p,className:"px-3 py-1 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 disabled:opacity-50",children:[p?(0,a.jsx)("i",{className:"fas fa-spinner fa-spin mr-1"}):null,"上傳至相簿"]})]}),(0,a.jsx)("div",{className:"border border-slate-200 rounded-xl overflow-hidden bg-slate-100",children:(0,a.jsx)("canvas",{ref:e,className:"w-full touch-none cursor-crosshair",style:{height:400,display:"block"},onMouseDown:w,onMouseMove:v,onMouseUp:y,onMouseLeave:y,onTouchStart:w,onTouchMove:v,onTouchEnd:y})})]})}}},e=>{e.O(0,[399,563,320,441,255,358],()=>e(e.s=2740)),_N_E=e.O()}]);